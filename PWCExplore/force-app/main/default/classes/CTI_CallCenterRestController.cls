/*------------------------------------------------------------------------
Author:        HansRaj Yadav
Company:       PWC
Description:   Controller class for logging call history
Inputs:        CaseId
Test Class:    

Modification Log :

* Developer             Date               Description
---------------------------------------------------------------------------
* HansRaj Yadav         17-04-2024        Initial Release
* 
----------------------------------------------------------------------------*/
@RestResource(urlMapping='/v1/CallCenter/LogCall')
global class CTI_CallCenterRestController {
    

    @HttpPost
    global static void logCallHistory(){
        RestRequest request = RestContext.request;
        RestResponse res = RestContext.response;
        CTI_ResponseWrap resp = new CTI_ResponseWrap();

        String jsonReq = RestContext.request.requestBody.toString();
        
        IVR_RequestWrapper wrapInst = (IVR_RequestWrapper)JSON.deserialize(jsonReq,IVR_RequestWrapper.class);
        

        
        // Logic will be here 
        System.debug('000-- '+wrapInst.durationOfCall);
        
        Task logCallRcrd = new Task(
            	
            TaskSubtype = 'Task',
            Type = 'Call',
            CallDurationInSeconds = wrapInst.durationOfCall != null && wrapInst.durationOfCall !=''  ? Integer.valueOf(wrapInst.durationOfCall) : null, 
            WhatId =   wrapInst.caseId,
            Description = 'Description msg for call '+ wrapInst.mobileNo,
            CallDisposition = wrapInst.callRemarks
            
            //Contact ID            WhoId =       
        );
        logCallRcrd.Subject= 'CallType to '+ wrapInst.mobileNo + '- Others (' +logCallRcrd.CallDurationInSeconds + ')';

        String[] strTimeSplit = wrapInst.callStartTime.split(':');
        String [] strEndTime = wrapInst.callEndTime.split(':');
        logCallRcrd.Call_Start_Time__c = Time.newInstance(Integer.valueOf(strTimeSplit[0]),Integer.valueOf(strTimeSplit[1]),Integer.valueOf(strTimeSplit[2]),0);    
		logCallRcrd.Call_End_Time__c = Time.newInstance(Integer.valueOf(strEndTime[0]),Integer.valueOf(strEndTime[1]),Integer.valueOf(strEndTime[2]),0);    

        Database.SaveResult saveResults = Database.insert(logCallRcrd);
        System.debug('srv '+saveResults);

        if( saveResults.isSuccess() ){
            resp.status = true;
        
        } else{
            resp.status = false;
        }

        //Logic ends here
        String jsonresponse= JSON.serializePretty(resp);
        res.addHeader('Content-Type', 'application/json');
        res.responseBody = Blob.valueOf(jsonresponse);
        //RestContext.response = res;
    }


    //
//Generated by AdminBooster
//

    public class IVR_RequestWrapper {
        public String contactId;
        public String caseId;	//320200904171501
        public String mobileNo;	//9415610432
        public String recordingFileName;
        public String callStartTime;
        public String callEndTime;
        public String durationOfCall;
        public String agentWhoAttendedCall;
        public String typeOfCall;
        public String callRemarks;
    }

    public class CTI_ResponseWrap {
        public Boolean status = false;
        public String statusRemarks;

    }
}